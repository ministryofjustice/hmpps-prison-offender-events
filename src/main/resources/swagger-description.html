<h3>Generate events for the offender changes in prison</h3>
<p>Background service for generating events for the <b>offender-events</b> topic and <b>hmpps-domain-events</b> topic from DPS and NOMIS changes indicating a change to an offender in prison</p>
<p>
    Events are generated when this service detects a change in NOMIS/DPS via database triggers or when a service determines a significant event has happened.
</p>
<p>
  The events published to the <b>offender-events</b> topic tend to be events closely related the database tables that have been updated and are often fine grained.
</p>
<p>
  The events published to the <b>hmpps-domain-events</b> topic tend to be coarse grained business events to better represent the real world changes.
</p>
<h4>Prison specific events - <b>offender-events</b> topic</h4>
<div>
    <p>
      Meta data about the event included as a SQS Message Attribute is as follows:
      <ul>
        <li><b>eventType</b> see below for all event types - this is also included in the message</li>
        <li><b>code</b> optional code that represents either the Alert Code for alerts of the movement Type with direction for events that contain movements</li>
        <li><b>publishedAt</b> the zoned timestamp when this events was published e.g 2020-12-04T10:42:43+01:00, 2020-12-04T10:42:43Z</li>
      </ul>
    </p>
    The specific events currently being raised are
    <ul>
      <li><b>ACHIEVEMENTS-CARATS</b></li>
      <li><b>ACHIEVEMENTS-CHAPLAINCY</b></li>
      <li><b>ACHIEVEMENTS-EDUCATION</b></li>
      <li><b>ACHIEVEMENTS-GYM</b></li>
      <li><b>ACHIEVEMENTS-LNG</b></li>
      <li><b>ACHIEVEMENTS-OMU</b></li>
      <li><b>ACHIEVEMENTS-OTHER</b></li>
      <li><b>ACHIEVEMENTS-RESIDENCE</b></li>
      <li><b>ACHIEVEMENTS-SAFER</b></li>
      <li><b>ACHIEVEMENTS-WORKSHOPS</b></li>
      <li><b>ACP-ASSESSMENT</b></li>
      <li><b>ACP-CONS_WRK</b></li>
      <li><b>ACP-GEN_VISIT</b></li>
      <li><b>ACP-IA</b></li>
      <li><b>ACP-OT</b></li>
      <li><b>ACP-PPREPC</b></li>
      <li><b>ACP-PROG_FIN</b></li>
      <li><b>ACP-PROG_START</b></li>
      <li><b>ACP-RE</b></li>
      <li><b>ACP-RF</b></li>
      <li><b>ADDRESS_USAGE-DELETED</b></li>
      <li><b>ADDRESS_USAGE-INSERTED</b></li>
      <li><b>ADDRESS_USAGE-UPDATED</b></li>
      <li><b>ALERT</b></li>
      <li><b>ALERT-ACTIVE</b></li>
      <li><b>ALERT-INACTIVE</b></li>
      <li><b>ALERT-INSERTED</b></li>
      <li><b>ALERT-UPDATED</b></li>
      <li><b>ASSESSMENT-CHANGED</b></li>
      <li><b>BALANCE_UPDATE</b></li>
      <li><b>BED_ASSIGNMENT_HISTORY-INSERTED</b></li>
      <li><b>BOOKING_NUMBER-CHANGED</b></li>
      <li><b>CAB-APAS</b></li>
      <li><b>CAB-CHAPLAINCY</b></li>
      <li><b>CAB-CUST</b></li>
      <li><b>CAB-EDUCATION</b></li>
      <li><b>CAB-EQUALITIES</b></li>
      <li><b>CAB-GYM</b></li>
      <li><b>CAB-HCC</b></li>
      <li><b>CAB-MDT</b></li>
      <li><b>CAB-OMU</b></li>
      <li><b>CAB-OTHER</b></li>
      <li><b>CAB-RECEPTION</b></li>
      <li><b>CAB-REGIMES</b></li>
      <li><b>CAB-RESIDENCE</b></li>
      <li><b>CAB-SAFER</b></li>
      <li><b>CAB-SEG</b></li>
      <li><b>CAB-VID</b></li>
      <li><b>CAB-VISITS</b></li>
      <li><b>CAB-WORKSHOPS</b></li>
      <li><b>CHAP-BERSERILL</b></li>
      <li><b>CHAP-COMLINKS</b></li>
      <li><b>CHAP-FAITH</b></li>
      <li><b>CHAP-FAMMAR</b></li>
      <li><b>CHAP-GPS</b></li>
      <li><b>CHAP-HSY</b></li>
      <li><b>CHAP-OPV</b></li>
      <li><b>CHAP-RECSTAT</b></li>
      <li><b>CHAP-SSY</b></li>
      <li><b>COMMS-CHAPLAINCY</b></li>
      <li><b>COMMS-COM_IN</b></li>
      <li><b>COMMS-COM_OUT</b></li>
      <li><b>COMMS-CUST</b></li>
      <li><b>COMMS-FINANCE</b></li>
      <li><b>COMMS-MAIL</b></li>
      <li><b>COMMS-OMU</b></li>
      <li><b>COMMS-OTHER</b></li>
      <li><b>COMMS-RESIDENCE</b></li>
      <li><b>COMMS-SAFER</b></li>
      <li><b>COMMS-SECURITY</b></li>
      <li><b>COMMS-SEG</b></li>
      <li><b>CONFIRMED_RELEASE_DATE-CHANGED</b></li>
      <li><b>CONTACT_PERSON-DELETED</b></li>
      <li><b>CONTACT_PERSON-INSERTED</b></li>
      <li><b>CONTACT_PERSON-UPDATED</b></li>
      <li><b>COURT_SENTENCE-CHANGED</b></li>
      <li><b>CUSP-CUSP</b></li>
      <li><b>CVM-CVMB</b></li>
      <li><b>CVM-CVMG</b></li>
      <li><b>CVM-CVMI</b></li>
      <li><b>CVM-CVMM</b></li>
      <li><b>CVM-CVMR</b></li>
      <li><b>CVM-CVMV</b></li>
      <li><b>D1_RESULT</b></li>
      <li><b>D2_RESULT</b></li>
      <li><b>DISCHARGE</b></li>
      <li><b>EARNED_HDC-ACTIVITY_ATT</b></li>
      <li><b>EDUCATION_LEVEL-INSERTED</b></li>
      <li><b>EXTERNAL_MOVEMENT_RECORD-INSERTED</b></li>
      <li><b>GEN-HIS</b></li>
      <li><b>GEN-OSE</b></li>
      <li><b>GEN-RESET</b></li>
      <li><b>GEN-WELFCHK</b></li>
      <li><b>HDC_CONDITION-CHANGED</b></li>
      <li><b>HDC_FINE-INSERTED</b></li>
      <li><b>HEARING_DATE-CHANGED</b></li>
      <li><b>HEARING_RESULT-CHANGED</b></li>
      <li><b>HEARING_RESULT-DELETED</b></li>
      <li><b>IEP_CHANGED</b></li>
      <li><b>IIS_END_OF_DAY</b></li>
      <li><b>IIS_END_OF_DAY_PR</b></li>
      <li><b>IMPRISONMENT_STATUS-CHANGED</b></li>
      <li><b>INCIDENT-CHANGED-CASES</b></li>
      <li><b>INCIDENT-CHANGED-PARTIES</b></li>
      <li><b>INCIDENT-CHANGED-REQUIREMENTS</b></li>
      <li><b>INCIDENT-CHANGED-RESPONSES</b></li>
      <li><b>INCIDENT-DELETED-PARTIES</b></li>
      <li><b>INCIDENT-DELETED-RESPONSES</b></li>
      <li><b>INCIDENT-INSERTED</b></li>
      <li><b>INTERNAL_LOCATION_CHANGED</b></li>
      <li><b>INTERVENTION-ACTIVITY</b></li>
      <li><b>INTERVENTION-CARATS</b></li>
      <li><b>INTERVENTION-CUST</b></li>
      <li><b>INTERVENTION-DIVERSITY</b></li>
      <li><b>INTERVENTION-HCC</b></li>
      <li><b>INTERVENTION-OMU</b></li>
      <li><b>INTERVENTION-OTHER</b></li>
      <li><b>INTERVENTION-RESIDENCE</b></li>
      <li><b>INTERVENTION-SECURITY</b></li>
      <li><b>INTERVENTION-VIOLENCE</b></li>
      <li><b>INTERVENTION-VISITS</b></li>
      <li><b>KA-KE</b></li>
      <li><b>KA-KS</b></li>
      <li><b>LAB_ALLOC-LAB_APP</b></li>
      <li><b>M3_RESULT</b></li>
      <li><b>MATERNITY_STATUS-INSERTED</b></li>
      <li><b>MCHECK-MCHECK</b></li>
      <li><b>MOVED_CELL-GM</b></li>
      <li><b>MOVED_CELL-HOSP</b></li>
      <li><b>MOVED_CELL-PCM</b></li>
      <li><b>MOVED_CELL-RAIM</b></li>
      <li><b>MOVED_CELL-SPP</b></li>
      <li><b>MOVED_CELL-SS</b></li>
      <li><b>NCS-FOLLOW</b></li>
      <li><b>NCS-IND</b></li>
      <li><b>NCS-PRE</b></li>
      <li><b>NEG-BEHAVEWARN</b></li>
      <li><b>NEG-IEP_WARN</b></li>
      <li><b>NEG-NEG_GEN</b></li>
      <li><b>NEG-WORKWARN</b></li>
      <li><b>NOTIFICATION_C</b></li>
      <li><b>OBSERVE-CARATS</b></li>
      <li><b>OBSERVE-CHAPLAINCY</b></li>
      <li><b>OBSERVE-EDUCATION</b></li>
      <li><b>OBSERVE-GYM</b></li>
      <li><b>OBSERVE-HCC</b></li>
      <li><b>OBSERVE-LNG</b></li>
      <li><b>OBSERVE-OBS_GEN</b></li>
      <li><b>OBSERVE-OMU</b></li>
      <li><b>OBSERVE-OTHER</b></li>
      <li><b>OBSERVE-RECEPTION</b></li>
      <li><b>OBSERVE-RESIDENCE</b></li>
      <li><b>OBSERVE-SAFER</b></li>
      <li><b>OBSERVE-SECURITY</b></li>
      <li><b>OBSERVE-SEG</b></li>
      <li><b>OBSERVE-THREAT_PR</b></li>
      <li><b>OBSERVE-THREAT_ST</b></li>
      <li><b>OBSERVE-VID</b></li>
      <li><b>OBSERVE-VISITS</b></li>
      <li><b>OBSERVE-WORKSHOPS</b></li>
      <li><b>OFFENDER-DELETED</b></li>
      <li><b>OFFENDER-INSERTED</b></li>
      <li><b>OFFENDER-UPDATED</b></li>
      <li><b>OFFENDER_ADDRESS-DELETED</b></li>
      <li><b>OFFENDER_ADDRESS-UPDATED</b></li>
      <li><b>OFFENDER_BOOKING-CHANGED</b></li>
      <li><b>OFFENDER_BOOKING-INSERTED</b></li>
      <li><b>OFFENDER_BOOKING-REASSIGNED</b></li>
      <li><b>OFFENDER_DETAILS-CHANGED</b></li>
      <li><b>OFFENDER_EMPLOYMENT-INSERTED</b></li>
      <li><b>OFFENDER_EMPLOYMENT-UPDATED</b></li>
      <li><b>OFFENDER_IDENTIFIER-DELETED</b></li>
      <li><b>OFFENDER_IDENTIFIER-INSERTED</b></li>
      <li><b>OFFENDER_MOVEMENT-DISCHARGE</b></li>
      <li><b>OFFENDER_MOVEMENT-RECEPTION</b></li>
      <li><b>OFFENDER_PROFILE_DETAILS-INSERTED</b></li>
      <li><b>OFFENDER_PROFILE_DETAILS-UPDATED</b></li>
      <li><b>OFFENDER_SANCTION-CHANGED</b></li>
      <li><b>OPD-OPDAJ</b></li>
      <li><b>OPD-OPDAOA</b></li>
      <li><b>OPD-OPDOC</b></li>
      <li><b>OPD-OPDPPES</b></li>
      <li><b>OPD-OPDPPRA</b></li>
      <li><b>OPD-OPDPRW</b></li>
      <li><b>P7_RESULT</b></li>
      <li><b>PERSONAL_DETAILS_CHANGED</b></li>
      <li><b>PERSONAL_OFFICER_CHANGED</b></li>
      <li><b>PERSON_ADDRESS-DELETED</b></li>
      <li><b>PERSON_ADDRESS-INSERTED</b></li>
      <li><b>PERSON_ADDRESS-UPDATED</b></li>
      <li><b>PHONE-INSERTED</b></li>
      <li><b>PHONE-UPDATED</b></li>
      <li><b>POS-IEP_ENC</b></li>
      <li><b>POS-POS_GEN</b></li>
      <li><b>POS-QUAL_ATT</b></li>
      <li><b>POS-QUAL_WK</b></li>
      <li><b>PRISON-RELEASE</b></li>
      <li><b>RECEPTION</b></li>
      <li><b>REPORT-CARATS</b></li>
      <li><b>REPORT-CUST</b></li>
      <li><b>REPORT-DIVERSITY</b></li>
      <li><b>REPORT-EDUCATION</b></li>
      <li><b>REPORT-FINANCE</b></li>
      <li><b>REPORT-GYM</b></li>
      <li><b>REPORT-H</b></li>
      <li><b>REPORT-HCC</b></li>
      <li><b>REPORT-LNG</b></li>
      <li><b>REPORT-MAIL</b></li>
      <li><b>REPORT-MDT</b></li>
      <li><b>REPORT-OCA</b></li>
      <li><b>REPORT-OMU</b></li>
      <li><b>REPORT-OTHER</b></li>
      <li><b>REPORT-POE</b></li>
      <li><b>REPORT-REGIMES</b></li>
      <li><b>REPORT-RESIDENCE</b></li>
      <li><b>REPORT-SAFER</b></li>
      <li><b>REPORT-SECURITY</b></li>
      <li><b>REPORT-SEG</b></li>
      <li><b>REPORT-VIOLENCE</b></li>
      <li><b>REPORT-WORKSHOPS</b></li>
      <li><b>REPORTS-CHAPLAINCY</b></li>
      <li><b>REPORTS-REP_GEN</b></li>
      <li><b>REPORTS-REP_IEP</b></li>
      <li><b>REPORTS-REP_WNG</b></li>
      <li><b>REQUIREMENT-REQTERM</b></li>
      <li><b>RESTA-METRA</b></li>
      <li><b>ROTL-BOARD</b></li>
      <li><b>ROTL-RGEH</b></li>
      <li><b>SC-SC</b></li>
      <li><b>SENTENCE-IMPOSED</b></li>
      <li><b>SENTENCE-SENTERM</b></li>
      <li><b>SENTENCE_CALCULATION_DATES-CHANGED</b></li>
      <li><b>SENTENCE_DATES-CHANGED</b></li>
      <li><b>SENTENCE_INFORMATION_CHANGED</b></li>
      <li><b>SEQ-EDU</b></li>
      <li><b>TRANSFER-FROMTOL</b></li>
      <li><b>TRNG-TRNGALL</b></li>
      <li><b>TRNG-TRNGCOM</b></li>
    </ul>
</div>
<h4>HMPPS domain events - <b>hmpps-domain-events</b> topic</h4>
<div>
    The specific events currently being raised are
    <ul>
        <li>
          <b>prison-offender-events.prisoner.released</b> is raised when a prisoner is released from prison (as opposed to be transferred to another prison or a temporary absence)
          <ul>
            <li><b>eventType</b> string</li>
            <li><b>occurredAt</b> ISO local date time - when the release was recorded</li>
            <li><b>publishedAt</b> ISO local date time - when this event was first published</li>
            <li><b>version</b> number - version of this event message. Currently <b>1</b></li>
            <li><b>description</b> string - human readable description of event</li>
            <li><b>additionalInformation</b> object - additional information
              <ul>
                <li><b>nomsNumber</b> string - NOMIS offender number</li>
                <li><b>reason</b> enum - reason for the release. Will be one of these values
                  <ul>
                    <li><b>TEMPORARY_ABSENCE_RELEASE</b> prisoner has been temporarily released and is expected to return</li>
                    <li><b>RELEASED_TO_HOSPITAL</b> prisoner has been discharged in to the care of a hospital</li>
                    <li><b>RELEASED</b> prisoner has been discharged, typically into teh care of probation</li>
                    <li><b>SENT_TO_COURT</b> prisoner has sent to court</li>
                    <li><b>TRANSFERRED</b> prisoner is being transferred to another prison</li>
                    <li><b>UNKNOWN</b> not sure why the prisoner has been released</li>
                  </ul>
                </li>
                <li><b>detail</b> string - further human readable information about the reason. Example <b>Movement reason code YY</b>
                <li><b>currentLocation</b> enum  - indicates if prisoner is in or out of prison</b>
                  <ul>
                    <li><b>IN_PRISON</b> prisoner in a prison</li>
                    <li><b>OUTSIDE_PRISON</b> prisoner no longer in a prison</li>
                  </ul>
                </li>
                <li><b>currentPrisonStatus</b> enum  - indicates if prisoner is still actively cared for by a prison, and alias for ACTIVE/INACTION</b>
                  <ul>
                    <li><b>UNDER_PRISON_CARE</b> even if the prison is out of prison they are still attached to a prison and has not been discharged</li>
                    <li><b>NOT_UNDER_PRISON_CARE</b> prisoner has been discharged from prison</li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
        <li>
          <b>prison-offender-events.prisoner.received</b> is raised when a prisoner is received to prison, this may be due to remand, a conviction or a recall from a broken licence
          <ul>
            <li><b>eventType</b> string</li>
            <li><b>occurredAt</b> ISO local date time - when the receive booking was recorded</li>
            <li><b>publishedAt</b> ISO local date time - when this event was first published</li>
            <li><b>version</b> number - version of this event message. Currently <b>1</b></li>
            <li><b>description</b> string - human readable description of event</li>
            <li><b>additionalInformation</b> object - additional information
              <ul>
                <li><b>nomsNumber</b> string - NOMIS offender number</li>
                <li><b>reason</b> enum - reason for the receive. Will be one of these values
                  <ul>
                    <li><b>RECALL</b> prisoner is subject to a recall on their licence</li>
                    <li><b>REMAND</b> remanded in custody waiting court case result</li>
                    <li><b>CONVICTED</b> convicted on new charged</li>
                    <li><b>IMMIGRATION_DETAINEE</b> prisoner is subject to a deportation order</li>
                    <li><b>TEMPORARY_ABSENCE_RETURN</b> prisoner is returning from temporary absence e.g. day release</li>
                    <li><b>RETURN_FROM_COURT</b> prisoner is returning from court</li>
                    <li><b>TRANSFERRED</b> prisoner is been transferred from another prison</li>
                    <li><b>UNKNOWN</b> prisoner's legal status is unknown at this time so reason for booking is unknown </li>
                  </ul>
                </li>
                <li><b>source</b> enum - the primary source system that has determined the reason. Will be one of these values
                  <ul>
                    <li><b>PRISON</b> the typical case that the prison system (NOMIS) was used to calculate the reason</li>
                    <li><b>PROBATION</b> when the probation system (Delius) has an outstanding recall request which has not been recorded in NOMIS yet </li>
                  </ul>
                </li>
                <li><b>detail</b> string - further human readable information about the reason. Example <b>Recall referral date 2021-06-13</b>
                </li>
                <li><b>currentLocation</b> enum  - indicates if prisoner is in or out of prison</b>
                  <ul>
                    <li><b>IN_PRISON</b> prisoner in a prison</li>
                    <li><b>OUTSIDE_PRISON</b> prisoner no longer in a prison</li>
                  </ul>
                </li>
                <li><b>currentPrisonStatus</b> enum  - indicates if prisoner is still actively cared for by a prison, and alias for ACTIVE/INACTION</b>
                  <ul>
                    <li><b>UNDER_PRISON_CARE</b> even if the prison is out of prison they are still attached to a prison and has not been discharged</li>
                    <li><b>NOT_UNDER_PRISON_CARE</b> prisoner has been discharged from prison</li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
    </ul>
</div>
<h3>Topic subscription</h3>
<p>Clients are expected to use a SQS AWS queue to receive events with queue subscribed to <b>prison-events-topic</b> or <b>hmpps-domain-topic</b> or both. </p>
<p>Clients can subscribe to one or more events. A typical subscription could be:</p>
<pre>
    resource "aws_sns_topic_subscription" "my_probation_subscription" {
    provider      = aws.london
    topic_arn     = module.hmpps-domain-events.topic_arn
    protocol      = "sqs"
    endpoint      = module.my_queue.sqs_arn
    filter_policy = "{\"eventType\":[ \"prison-offender-events.prisoner.released\", \"prison-offender-events.prisoner.receive\"] }"
    }
</pre>
<p>and this would be defined in the Cloud Platform hmpps-domain-events namespace or the offender-events namespace for <b>offender_events</b></p>
