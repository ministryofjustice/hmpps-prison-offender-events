<h2>Generate events for the offender changes in prison</h2>
<p>Background service for generating events for the <b>hmpps-domain-events</b> topic from DPS and NOMIS changes indicating a change to an offender in prison</p>
<p>
    Events are generated when this service detects a change in NOMIS/DPS via hmpps-prisoner-events or when a service determines a significant event has happened.
</p>
<p>
  The events published to the <b>offender-events</b> topic tend to be events closely related the database tables that have been updated and are often fine grained.
</p>
<p>
  The events published to the <b>hmpps-domain-events</b> topic tend to be coarse grained business events to better represent the real world changes.
</p>
<h3>Prison specific events - <b>offender-events</b> topic</h3>
<div>
    <p>
      These are generated by hmpps-prisoner-events and are published to the <b>offender-events</b> topic.
      Metadata about the event included as a SQS Message Attribute is as follows:
    </p>
      <ul>
        <li><b>eventType</b> see below for all event types - this is also included in the message</li>
        <li><b>code</b> optional code that represents either the Alert Code for alerts of the movement Type with direction for events that contain movements</li>
        <li><b>publishedAt</b> the zoned ISO offset timestamp when this event was published e.g 2020-12-04T10:42:43+01:00, 2020-12-04T10:42:43Z</li>
      </ul>

</div>
<h3>HMPPS domain events - <b>hmpps-domain-events</b> topic</h3>
<div>
    This service receives prison events from hmpps-prisoner-events and other services and converts them, publishing them
    to the <b>hmpps-domain-events</b> topic. All events have these common fields:
    <ul>
      <li><b>eventType</b> string</li>
      <li><b>occurredAt</b> ISO offset date time - when the release was recorded e.g 2021-02-08T14:41:11.526762Z</li>
      <li><b>publishedAt</b> ISO offset date time - when this event was first published e.g 2021-06-08T14:41:11.526762+01:00</li>
      <li><b>version</b> number - version of this event message. Currently <b>1</b></li>
      <li><b>description</b> string - human-readable description of event</li>
    </ul>
</div>
<h4>Delayed events</h4>
<div>
  The events <b>prison-offender-events.prisoner.received</b> and <b>prison-offender-events.prisoner.released</b> have a
delay of 45 minutes built into them.
This means the event is only generated 45 minutes after the prisoner is released (or received), rather than immediately.
If they are then received (or released) back in again within that timeframe then the event will be suppressed and a
<b>not-released</b> event will be generated instead.

We have found that there are a number of reasons why a prisoner is released (or vica versa) and then shortly afterwards
received, such as:
<ol>
  <li>Release prior to a prisoner merge</li>
  <li>Where the prisoner never leaves reception</li>
  <li>Mistakes</li>
</ol>
We have found that these mistakes and alterations normally happen within the first 30 minutes, hence the 45 minute delay.

So in the scenario:
<ul>
  <li>User releases prisoner</li>
  <li>User receives same prisoner within 20 minutes</li>
</ul>
<ol>
  <li>No <b>prison-offender-events.prisoner.released</b> / <b>prison-offender-events.prisoner.received</b> events published</li>
  <li><b>prisoner-offender-search.prisoner.released</b> published immediately</li>
  <li><b>prisoner-offender-search.prisoner.received</b> published 20 minutes later (when they are received back into NOMIS)</li>
  <li><b>prison-offender-events.prisoner.not-released</b> published 45 minutes later</li>
</ol>

Whereas in this scenario:
<ul>
  <li>User releases prisoner</li>
  <li>User receives same prisoner 60 minutes later</li>
</ul>
<ol>
  <li><b>prisoner-offender-search.prisoner.released</b> published immediately</li>
  <li><b>prisoner-offender-events.prisoner.released</b> 45 minutes later</li>
  <li><b>prisoner-offender-search.prisoner.received</b> published 60 minutes later (when they are received back into NOMIS)</li>
  <li><b>prisoner-offender-events.prisoner.received</b> published 105 minutes later (when 45 minutes after they are received back into NOMIS)</li>
</ol>

If you have a service that just doesn't care that release events might be fired even when the prisoner
does not physically leave the prison and your data will be restored back in the correct state after the receive event
then you may as well listen on the search events, if on the other hand your service has side-effects on a release
(setting of fireworks, sending out emails, cancelling visits) you might want to consider listening on the more
conservative <b>offender.events</b>.
</div>
<h4>Event details</h4>
<p>Fields marked with <span style="color: red">*</span> are mandatory in the event message, otherwise they are nullable.</p>
<div>
    <ul>
      <li>
        <b>prison-offender-events.prisoner.released</b> is raised when a prisoner is released from prison, this includes temporary releases
        such as court appearances and transfers. We would recommend consumers to ensure their service is idempotent, there are scenarios where multiple events maybe raised for same release.
        <h3>Additional Information</h3>
            <ul>
              <li><b>nomsNumber <span style="color: red">*</span></b> string - NOMIS offender number</li>
              <li><b>reason <span style="color: red">*</span></b> enum - reason for the release. Will be one of these values
                <ul>
                  <li><b>TEMPORARY_ABSENCE_RELEASE</b> prisoner has been temporarily released and is expected to return</li>
                  <li><b>RELEASED_TO_HOSPITAL</b> prisoner has been discharged in to the care of a hospital</li>
                  <li><b>RELEASED</b> prisoner has been discharged, typically into the care of probation</li>
                  <li><b>SENT_TO_COURT</b> prisoner has sent to court</li>
                  <li><b>TRANSFERRED</b> prisoner is being transferred to another prison</li>
                  <li><b>UNKNOWN</b> not sure why the prisoner has been released</li>
                </ul>
              </li>
              <li><b>details</b> string - further human readable information about the reason. The contents is developer focused and not to be relied on. Example <b>Movement reason code YY</b>
              <li><b>currentLocation</b> enum  - indicates if prisoner is in or out of prison
                <ul>
                  <li><b>IN_PRISON</b> prisoner in a prison</li>
                  <li><b>OUTSIDE_PRISON</b> prisoner no longer in a prison</li>
                  <li><b>BEING_TRANSFERRED</b> prisoner is being transferred</li>
                </ul>
              </li>
              <li><b>currentPrisonStatus</b> enum  - indicates if prisoner is still actively cared for by a prison, and alias for ACTIVE/INACTION
                <ul>
                  <li><b>UNDER_PRISON_CARE</b> even if the prison is out of prison they are still attached to a prison and has not been discharged</li>
                  <li><b>NOT_UNDER_PRISON_CARE</b> prisoner has been discharged from prison</li>
                </ul>
              </li>
              <li><b>prisonId <span style="color: red">*</span></b> string - the current prison where the prisoner was last located</li>
              <li><b>nomisMovementReasonCode <span style="color: red">*</span></b> string - the reason code for the last movement. Since this is the literal NOMIS reference data that can change clients should be cautious of tightly integrating with this value. MOVE_RSN is the reference data domain in NOMIS</li>
            </ul>
      </li>
      <li>
        <b>prison-offender-events.prisoner.received</b> is raised when a prisoner is received to prison, this may be due to remand, a conviction or a recall from a broken licence. Also included are returns from temporary absences and transfers.
        We would recommend consumers to ensure their service is idempotent, there are scenarios where multiple events maybe raised for same receive.
        <h3>Additional Information</h3>
            <ul>
              <li><b>nomsNumber <span style="color: red">*</span></b> string - NOMIS offender number</li>
              <li><b>reason <span style="color: red">*</span></b> enum - reason for the receive. Will be one of these values below. It has been observed that administration mistakes in NOMIS can cause the reason for RECALL and CONVICTED to be not always be accurate.
                <ul>
                  <li><b>ADMISSION</b> prisoner is entering prison due to a new court order or recall</li>
                  <li><b>TEMPORARY_ABSENCE_RETURN</b> prisoner is returning from temporary absence e.g. day release</li>
                  <li><b>RETURN_FROM_COURT</b> prisoner is returning from court</li>
                  <li><b>TRANSFERRED</b> prisoner has been transferred from another prison</li>
                </ul>
              </li>
              <li><b>details</b> string - further human readable information about the reason. The contents is developer focused and not to be relied on. Example<b>Recall referral date 2021-06-13</b>
              </li>
              <li><b>currentLocation</b> enum  - indicates if prisoner is in or out of prison
                <ul>
                  <li><b>IN_PRISON</b> prisoner in a prison</li>
                  <li><b>OUTSIDE_PRISON</b> prisoner no longer in a prison</li>
                  <li><b>BEING_TRANSFERRED</b> prisoner is being transferred</li>
                </ul>
              </li>
              <li><b>currentPrisonStatus</b> enum  - indicates if prisoner is still actively cared for by a prison, and alias for ACTIVE/INACTION
                <ul>
                  <li><b>UNDER_PRISON_CARE</b> even if the prison is out of prison they are still attached to a prison and has not been discharged</li>
                  <li><b>NOT_UNDER_PRISON_CARE</b> prisoner has been discharged from prison</li>
                </ul>
              </li>
              <li><b>prisonId <span style="color: red">*</span></b> string - the current prison where the prisoner was last located</li>
              <li><b>nomisMovementReasonCode <span style="color: red">*</span></b> string - the reason code for the last movement. Since this is the literal NOMIS reference data that can change clients should be cautious of tightly integrating with this value. MOVE_RSN is the reference data domain in NOMIS</li>
            </ul>
      </li>
      <li>
        <b>prison-offender-events.prisoner.merged</b> is raised when a prisoner is merged into an exists prisoner record. This will mean that the prisoner will be
        now attached to the original NOMS (prisoner) number and the new one removed from NOMIS
        <h3>Additional Information</h3>
            <ul>
              <li><b>reason</b> enum -
                <ul>
                  <li><b>MERGE</b> indicates the prisoner records have been merged</li>
                </ul>
              </li>
              <li><b>nomsNumber</b> string - NOMS number of the prisoner (this will be the value that the prisoner record now holds)</li>
              <li><b>removedNomsNumber</b> string - NOMS number that was MERGED into <em>nomsNumber</em> and then removed</li>
            </ul>
      </li>
      <li>
        <b>prison-offender-events.prisoner.non-association-detail.changed</b> is raised when a prisoner non-association is created/updated/deleted.
        These events occur in pairs because the non-association is created both ways round.
        <h3>Additional Information</h3>
        <ul>
          <li><b>nomsNumber</b> string - NOMS number of the first prisoner</li>
          <li><b>nonAssociationNomsNumber</b> string - NOMS number of the second prisoner</li>
          <li><b>nonAssociationType</b> enum -
            <ul>
              <li><b>WING</b> indicates the prisoner should not be located on the same wing</li>
              <li><b>LANDING</b> indicates the prisoner should not be located on the same landing</li>
            </ul>
          </li>
          <li><b>reasonCode</b> enum -
            <ul>
              <li><b>BUL</b> anti-bullying strategy</li>
              <li><b>PER</b> perpetrator</li>
              <li><b>RIV</b> rival gang</li>
              <li><b>VIC</b> victim</li>
            </ul>
          </li>
          <li><b>levelCode</b> not used</li>
          <li><b>bookingId</b> string - NOMIS booking id of the first prisoner</li>
          <li><b>nonAssociationBookingId</b> string - NOMIS booking id of the second prisoner</li>
          <li><b>typeSeq</b> not used</li>
          <li><b>effectiveDate</b> string - start date of non-association</li>
          <li><b>expiryDate</b> string - optional end date</li>
          <li><b>authorisedBy</b> string - free text authorising entity</li>
          <li><b>comment</b> string - optional comment</li>
        </ul>
      </li>
      <li>
        <b>prison-offender-events.prisoner.restriction.changed</b> is raised when a prisoner visits restriction is created/updated/deleted.
        <h3>Additional Information</h3>
        <ul>
          <li><b>nomsNumber</b> string - NOMS number of the prisoner</li>
          <li><b>bookingId</b> string - NOMIS booking id of the prisoner</li>
          <li><b>offenderRestrictionId</b> string - NOMIS id of the restriction record</li>
          <li><b>restrictionType</b> enum (from domain 'VST_RST_TYPE') -
            <ul>
              <li><b>ACC</b> access requirements</li>
              <li><b>BAN</b> banned</li>
              <li><b>CCTV</b> CCTV</li>
              <li><b>CHILD</b> child visitors to be vetted</li>
              <li><b>CLOSED</b> closed</li>
              <li><b>DIHCON</b> disability health concerns</li>
              <li><b>NONCON</b> non-contact visit</li>
              <li><b>PREINF</b> previous info</li>
              <li><b>RESTRICT</b> restricted</li>
            </ul>
          </li>
          <li><b>effectiveDate</b> string - start date of restriction</li>
          <li><b>expiryDate</b> string - optional end date</li>
          <li><b>comment</b> string - optional comment</li>
          <li><b>authorisedById</b> string - NOMIS staff id of authoriser</li>
          <li><b>enteredById</b> string - NOMIS staff id of creator</li>
        </ul>
      </li>
      <li>
        <b>prison-offender-events.prisoner.person-restriction.upserted</b> is raised when a global visitor restriction is created or updated.
        <h3>Additional Information</h3>
        <ul>
          <li><b>contactPersonId</b> string - NOMIS contact id of the visitor</li>
          <li><b>offenderPersonRestrictionId</b> string - NOMIS id of the restriction record</li>
          <li><b>personId</b> string - NOMIS person id of the restriction record</li>
          <li><b>restrictionType</b> enum (from domain 'VST_RST_TYPE') -
            <ul>
              <li><b>ACC</b> access requirements</li>
              <li><b>BAN</b> banned</li>
              <li><b>CCTV</b> CCTV</li>
              <li><b>CHILD</b> child visitors to be vetted</li>
              <li><b>CLOSED</b> closed</li>
              <li><b>DIHCON</b> disability health concerns</li>
              <li><b>NONCON</b> non-contact visit</li>
              <li><b>PREINF</b> previous info</li>
              <li><b>RESTRICT</b> restricted</li>
            </ul>
          </li>
          <li><b>effectiveDate</b> string - start date of restriction</li>
          <li><b>expiryDate</b> string - optional end date</li>
          <li><b>comment</b> string - optional comment</li>
          <li><b>authorisedById</b> string - NOMIS staff id of authoriser</li>
          <li><b>enteredById</b> string - NOMIS staff id of creator</li>
        </ul>
      </li>
      <li>
        <b>prison-offender-events.prisoner.person-restriction.deleted</b> is raised when a global visitor restriction is deleted.
        <h3>Additional Information</h3>
        <ul>
          <li><b>contactPersonId</b> string - NOMIS contact id of the visitor</li>
          <li><b>offenderPersonRestrictionId</b> string - NOMIS id of the restriction record</li>
          <li><b>personId</b> string - NOMIS person id of the restriction record</li>
          <li><b>restrictionType</b> enum (from domain 'VST_RST_TYPE') -
            <ul>
              <li><b>ACC</b> access requirements</li>
              <li><b>BAN</b> banned</li>
              <li><b>CCTV</b> CCTV</li>
              <li><b>CHILD</b> child visitors to be vetted</li>
              <li><b>CLOSED</b> closed</li>
              <li><b>DIHCON</b> disability health concerns</li>
              <li><b>NONCON</b> non-contact visit</li>
              <li><b>PREINF</b> previous info</li>
              <li><b>RESTRICT</b> restricted</li>
            </ul>
          </li>
          <li><b>effectiveDate</b> string - start date of restriction</li>
          <li><b>expiryDate</b> string - optional end date</li>
          <li><b>comment</b> string - optional comment</li>
          <li><b>authorisedById</b> string - NOMIS staff id of authoriser</li>
          <li><b>enteredById</b> string - NOMIS staff id of creator</li>
        </ul>
      </li>
      <li>
        <b>prison-offender-events.visitor.restriction.upserted</b> is raised when a global visitor restriction is created or updated
        <h3>Additional Information</h3>
        <ul>
          <li><b>personId</b> string - NOMIS person id of the visitor</li>
          <li><b>visitorRestrictionId</b> string - NOMIS id of the restriction record</li>
          <li><b>restrictionType</b> enum (from domain 'VST_RST_TYPE') -
            <ul>
              <li><b>ACC</b> access requirements</li>
              <li><b>BAN</b> banned</li>
              <li><b>CCTV</b> CCTV</li>
              <li><b>CHILD</b> child visitors to be vetted</li>
              <li><b>CLOSED</b> closed</li>
              <li><b>DIHCON</b> disability health concerns</li>
              <li><b>NONCON</b> non-contact visit</li>
              <li><b>PREINF</b> previous info</li>
              <li><b>RESTRICT</b> restricted</li>
            </ul>
          </li>
          <li><b>effectiveDate</b> string - start date of restriction</li>
          <li><b>expiryDate</b> string - optional end date</li>
          <li><b>enteredById</b> string - NOMIS staff id of creator</li>
        </ul>
      </li>
      <li>
        <b>prison-offender-events.visitor.restriction.deleted</b> is raised when a global visitor restriction is deleted
        <h3>Additional Information</h3>
        <ul>
          <li><b>personId</b> string - NOMIS person id of the visitor</li>
          <li><b>visitorRestrictionId</b> string - NOMIS id of the restriction record</li>
          <li><b>restrictionType</b> enum (from domain 'VST_RST_TYPE') -
            <ul>
              <li><b>ACC</b> access requirements</li>
              <li><b>BAN</b> banned</li>
              <li><b>CCTV</b> CCTV</li>
              <li><b>CHILD</b> child visitors to be vetted</li>
              <li><b>CLOSED</b> closed</li>
              <li><b>DIHCON</b> disability health concerns</li>
              <li><b>NONCON</b> non-contact visit</li>
              <li><b>PREINF</b> previous info</li>
              <li><b>RESTRICT</b> restricted</li>
            </ul>
          </li>
          <li><b>effectiveDate</b> string - start date of restriction</li>
          <li><b>expiryDate</b> string - optional end date</li>
          <li><b>enteredById</b> string - NOMIS staff id of creator</li>
        </ul>
      </li>
      <li>
        <b>prison-offender-events.prisoner.contact-added</b> is raised when a person is added as priosner contact
        <h3>Additional Information</h3>
        <ul>
          <li><b>nomsNumber</b> string - Prisoner number of the prisoner that has the contact</li>
          <li><b>bookingId</b> number - id of the booking record in NOMIS that contains the contact </li>
          <li><b>personId</b> number - id of the person record in NOMIS that contains information about the person, e.g. name, date of birth etc</li>
          <li><b>contactId</b> number - id of the contact record in NOMIS that contains information about the relationship, e.g. social, official, brother etc</li>
          <li><b>approvedVisitor</b> boolean - flag to indicate if the contact was an approved visitor at the point the event was triggered</li>
          <li><b>username</b> string - NOMIS user that made the change</li>
        </ul>
      </li>
      <li>
        <b>prison-offender-events.prisoner.contact-removed</b> is raised when a person has been removed as contact to a prisoner. Only the relationship is removed not the actual person
        <h3>Additional Information</h3>
        <ul>
          <li><b>nomsNumber</b> string - Prisoner number of the prisoner that has the contact</li>
          <li><b>bookingId</b> number - id of the booking record in NOMIS that contains the contact </li>
          <li><b>personId</b> number - id of the person record in NOMIS that contains information about the person, e.g. name, date of birth etc</li>
          <li><b>contactId</b> number - id of the contact record in NOMIS that contains information about the relationship, e.g. social, official, brother etc</li>
          <li><b>approvedVisitor</b> boolean - flag to indicate if the contact was an approved visitor at the point the event was triggered</li>
        </ul>
      </li>
      <li>
        <b>prison-offender-events.prisoner.contact-approved</b> is raised when a contact has been approved as visitor to the prisoner
        <h3>Additional Information</h3>
        <ul>
          <li><b>nomsNumber</b> string - Prisoner number of the prisoner that has the contact</li>
          <li><b>bookingId</b> number - id of the booking record in NOMIS that contains the contact </li>
          <li><b>personId</b> number - id of the person record in NOMIS that contains information about the person, e.g. name, date of birth etc</li>
          <li><b>contactId</b> number - id of the contact record in NOMIS that contains information about the relationship, e.g. social, official, brother etc</li>
          <li><b>approvedVisitor</b> boolean - flag to indicate if the contact was an approved visitor at the point the event was triggered - will be true</li>
          <li><b>username</b> string - NOMIS user that made the change</li>
        </ul>
      </li>
      <li>
        <b>prison-offender-events.prisoner.contact-unapproved</b> is raised when a contact has had their approval to visit the prisoner revoked
        <h3>Additional Information</h3>
        <ul>
          <li><b>nomsNumber</b> string - Prisoner number of the prisoner that has the contact</li>
          <li><b>bookingId</b> number - id of the booking record in NOMIS that contains the contact </li>
          <li><b>personId</b> number - id of the person record in NOMIS that contains information about the person, e.g. name, date of birth etc</li>
          <li><b>contactId</b> number - id of the contact record in NOMIS that contains information about the relationship, e.g. social, official, brother etc</li>
          <li><b>approvedVisitor</b> boolean - flag to indicate if the contact was an approved visitor at the point the event was triggered - will be false</li>
          <li><b>username</b> string - NOMIS user that made the change</li>
        </ul>
      </li>
    </ul>
</div>
<h2>Topic subscription</h2>
<p>Clients are expected to use a SQS AWS queue to receive events with queue subscribed to <b>prison-events-topic</b> or <b>hmpps-domain-topic</b> or both. </p>
<p>Clients can subscribe to one or more events. A typical subscription could be:</p>
<pre>
    resource "aws_sns_topic_subscription" "my_probation_subscription" {
    provider      = aws.london
    topic_arn     = module.hmpps-domain-events.topic_arn
    protocol      = "sqs"
    endpoint      = module.my_queue.sqs_arn
    filter_policy = "{\"eventType\":[ \"prison-offender-events.prisoner.released\", \"prison-offender-events.prisoner.receive\", \"prison-offender-events.prisoner.merged\"] }"
    }
</pre>
<p>and this would be defined in the Cloud Platform hmpps-domain-events namespace or the offender-events namespace for <b>offender_events</b></p>
